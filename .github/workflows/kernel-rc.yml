name: Build RC Kernel (CachyOS + BBRv3)

on:
  schedule:
    - cron: '15 1 * * *'
  workflow_dispatch:
    inputs:
      force:
        description: "Force rebuild even if release exists"
        required: false
        default: "false"

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    permissions:
      contents: write
    env:
      MARCH_FLAGS: "-march=icelake-client -mtune=icelake-client"
      LOCALVERSION: "-cachyos-rc"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Resolve latest RC
        id: rc
        run: bash scripts/resolve-rc.sh

      - name: Decide whether to build
        id: release
        if: steps.rc.outputs.is_rc == 'true'
        env:
          RC_VERSION: ${{ steps.rc.outputs.rc_version }}
          FORCE_BUILD: ${{ github.event.inputs.force || 'false' }}
        run: |
          python3 - <<'PY'
          import json
          import os
          import sys
          import urllib.error
          import urllib.request

          repo = os.environ["GITHUB_REPOSITORY"]
          rc_version = os.environ.get("RC_VERSION", "")
          localversion = os.environ.get("LOCALVERSION", "")
          force = os.environ.get("FORCE_BUILD", "false").lower() == "true"
          output = os.environ.get("GITHUB_OUTPUT", "/dev/stdout")

          if not rc_version:
              with open(output, "a") as fh:
                  fh.write("should_build=false\n")
              sys.exit(0)

          if force:
              with open(output, "a") as fh:
                  fh.write("should_build=true\n")
              sys.exit(0)

          asset_name = f"linux-{rc_version}{localversion}.tar.zst"
          url = f"https://api.github.com/repos/{repo}/releases/tags/rc-{rc_version}"
          headers = {"Accept": "application/vnd.github+json"}
          token = os.environ.get("GITHUB_TOKEN")
          if token:
              headers["Authorization"] = f"Bearer {token}"

          req = urllib.request.Request(url, headers=headers)
          try:
              with urllib.request.urlopen(req) as resp:
                  data = json.load(resp)
          except urllib.error.HTTPError as e:
              if e.code == 404:
                  with open(output, "a") as fh:
                      fh.write("should_build=true\n")
                  sys.exit(0)
              raise

          assets = [asset.get("name", "") for asset in data.get("assets", [])]
          should_build = asset_name not in assets
          with open(output, "a") as fh:
              fh.write(f"should_build={'true' if should_build else 'false'}\n")
          if not should_build:
              print(f"Release already has {asset_name}, skipping build.")
          PY

      - name: Skip non-RC
        if: steps.rc.outputs.is_rc != 'true'
        run: echo "mainline is not an RC release; skipping."

      - name: Free disk space
        if: steps.rc.outputs.is_rc == 'true' && steps.release.outputs.should_build == 'true'
        run: |
          sudo swapoff -a || true
          sudo rm -f /mnt/swapfile || true
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /usr/local/share/boost /usr/local/.ghcup || true
          sudo apt-get clean
          df -h

      - name: Install build dependencies
        if: steps.rc.outputs.is_rc == 'true' && steps.release.outputs.should_build == 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential bc bison flex libssl-dev libelf-dev dwarves \
            zstd rsync curl xz-utils python3 \
            binutils-dev libxxhash-dev zlib1g-dev

      - name: Build kernel
        if: steps.rc.outputs.is_rc == 'true' && steps.release.outputs.should_build == 'true'
        run: |
          bash scripts/build.sh "${{ steps.rc.outputs.rc_version }}" "${{ steps.rc.outputs.rc_major }}"

      - name: Publish release
        if: steps.rc.outputs.is_rc == 'true' && steps.release.outputs.should_build == 'true'
        uses: ncipollo/release-action@v1
        with:
          tag: rc-${{ steps.rc.outputs.rc_version }}
          name: rc-${{ steps.rc.outputs.rc_version }}
          prerelease: true
          allowUpdates: true
          replacesArtifacts: true
          artifacts: artifacts/linux-${{ steps.rc.outputs.rc_version }}${{ env.LOCALVERSION }}.tar.zst

      - name: Update ebuild
        if: steps.rc.outputs.is_rc == 'true' && steps.release.outputs.should_build == 'true'
        run: |
          bash scripts/update-ebuild.sh "${{ steps.rc.outputs.rc_version }}"
          if git status --porcelain | grep -q .; then
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add sys-kernel/rc-kernel-cachyos-bin
            git commit -m "Add ebuild for ${{ steps.rc.outputs.rc_version }}"
            git push
          fi

      - name: Upload artifacts
        if: steps.rc.outputs.is_rc == 'true' && steps.release.outputs.should_build == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: linux-${{ steps.rc.outputs.rc_version }}-cachyos-rc
          path: artifacts/
          if-no-files-found: error
